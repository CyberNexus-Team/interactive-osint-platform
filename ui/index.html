<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piattaforma OSINT Interattiva</title>
    <style>
        body { font-family: sans-serif; background-color: #1a1a1a; color: #f0f0f0; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 10px; }
        h1 { color: #00c853; }
        button { background-color: #00c853; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .search-section { background-color: #2a2a2a; padding: 20px; margin-top: 20px; border-radius: 8px; }
        h3 { border-bottom: 1px solid #444; padding-bottom: 5px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex-grow: 1; padding: 10px; background-color: #333; border: 1px solid #555; color: white; border-radius: 5px; }
        #status { margin-top: 20px; padding: 10px; background-color: #333; border-radius: 5px; min-height: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Piattaforma OSINT</h1>
            <button id="generate-report-btn" disabled>Genera Report</button>
        </div>

        <div id="osint-categories">
            <!-- Qui inseriremo le sezioni di ricerca più avanti -->
        </div>

        <div id="status">Pronto per l'indagine.</div>
    </div>

    <script>
        // --- LOGICA JAVASCRIPT ---

        // URL del webhook del nostro Master Workflow in n8n
        const N8N_WEBHOOK_URL = 'http://localhost:5678/webhook/osint-master'; // IMPORTANTE: Aggiorna se l'URL del webhook è diverso

        // 1. Generazione ID di Sessione Unico (UUID)
        // Questo ID identifica la nostra indagine corrente. Viene creato ogni volta che la pagina viene caricata.
        const sessionId = self.crypto.randomUUID();
        console.log(`Sessione di indagine iniziata con ID: ${sessionId}`);
        document.getElementById('status').innerText = `ID Sessione: ${sessionId}`;

        // 2. Funzioni Gestore
        // Queste funzioni (per ora vuote) verranno popolate nel Modulo 2
        // per gestire le singole ricerche.

        // 3. Gestore per il Bottone "Genera Report"
        const generateReportBtn = document.getElementById('generate-report-btn');
        generateReportBtn.addEventListener('click', async () => {
            const statusDiv = document.getElementById('status');
            statusDiv.innerText = 'Richiesta di generazione report in corso...';
            generateReportBtn.disabled = true;

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        action: 'generate_report'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Errore dal server: ${response.statusText}`);
                }

                // Il workflow n8n invierà il file PDF come allegato per il download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `OSINT_Report_${sessionId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                statusDiv.innerText = 'Report generato e scaricato. La sessione è stata terminata.';

            } catch (error) {
                console.error('Errore durante la generazione del report:', error);
                statusDiv.innerText = `Errore: ${error.message}`;
                // Non riabilitiamo il bottone, la sessione potrebbe essere corrotta.
            }
        });

        // 4. Funzione per Abilitare il Bottone Report
        // Sarà chiamata dopo la prima ricerca andata a buon fine.
        function enableReportButton() {
            if (generateReportBtn.disabled) {
                generateReportBtn.disabled = false;
                console.log('Bottone "Genera Report" abilitato.');
            }
        }
    </script>

</body>
</html>
